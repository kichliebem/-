

---

# 1) 全局未知量与索引

设

- 节点数 $N_n$，边/元件数 $N_e$。
    
- 我们把**每条边的两端口焓**都当未知（便于能量方程落在设备内部），于是端口焓未知数 $N_h=2N_e$。
    
- 有存储设备（房间、贮液罐…）的**动态状态**统称 $z$（每个设备 1～2 个，例：罐 $[L,h]$，房间 $[T]$）。
    

未知量统一排成  
$$  
x=\begin{bmatrix}  
p_{(N_n)}\  
\dot m_{(N_e)}\  
h_{(2N_e)}\  
z_{(N_z)}  
\end{bmatrix}  
$$  
其中：

- **压力 $p$** 对应“节点”；
    
- **质量流量 $\dot m$** 对应“边”（一条边一个 $\dot m$，符号按 from→to）；
    
- **端口焓 $h$**：每条边两端各一个，直接对应你界面里的 `IMx_ENTHALPY` 与 `EXx_ENTHALPY`；
    
- **动态状态 $z$**：如 `BKT_LEVEL/BKT_H`、`InsideTemperature` 等。
    

---

# 2) 全局残差（方程）如何写

## 2.1 质量守恒（节点连续性）

$$  
R^{(m)} = A,\dot m-b=0 \quad (\text{维度 }N_n)  
$$

- $A\in\mathbb{R}^{N_n\times N_e}$ 是节点–边**关联矩阵**（出 $-1$、入 $+1$）。
    
- `IMx_FLOW/EXx_FLOW` 在设备里保持一致，只往 $\dot m$ 这一个未知量上写。
    

## 2.2 压降–流量（每条边 1 条）

$$  
R^{(p)}_e=(A^T p)_e-\Delta p_e(\dot m_e;\ \rho,\mu,\text{几何/开度/曲线})=0 \quad (\text{维度 }N_e)  
$$

- $(A^T p)_e = p_{\text{out}} - p_{\text{in}}$；
    
- $\Delta p_e$ 由该设备的模型给出（管/阀/泵/压缩机/毛细…）；
    
- 物性 `DENSITY`/`VISCOSITY` 由 $\text{CoolProp}(p,h)$ 得到，用于 $\Delta p$ 的系数。
    

## 2.3 能量关系（每条边 1 条）

**无热源/无功**（阀、弯管、直管、毛细等简化）：  
$$  
R^{(h)}_e = h^{ex}_e - h^{im}_e = 0  
$$

**有功/换热**（压缩机、泵可能有升温、换热器、房间负荷等）：写成  
$$  
R^{(h)}_e = g_e\big(h^{im},h^{ex},p^{im},p^{ex},\dot m,UA,\eta,\dots\big)=0  
$$

例如压缩机等熵效率：  
$$  
h^{ex}=h^{im}+\frac{h^{ex,s}(p^{ex},s^{im})-h^{im}}{\eta_{is}}  
$$

> 这里的 $h^{im},h^{ex}$ 就是你变量表里的 `IMx_ENTHALPY / EXx_ENTHALPY`。

## 2.4 动态/储能设备（每个设备 1～2 条）

以**后向欧拉**为例（$\Delta t=S_T$）：  
$$  
R^{(z)} = g\big(z^{k+1},p^{k+1},\dot m^{k+1},h^{k+1}\big)=0  
$$

- 罐：质量+能量；房间：能量；盘管段：结点化后能量等。
    
- 用 CoolProp 取 $\rho(p,h)$、$c_p$ 等。
    

---

# 3) 雅可比矩阵块结构（解牛顿步）

把 $F=[R^{(m)};R^{(p)};R^{(h)};R^{(z)}]$ 对 $x=[p;\dot m;h;z]$ 求偏导，得到稀疏块矩阵：  
$$J=
\begin{bmatrix}
\dfrac{\partial R^{(m)}}{\partial p} & \dfrac{\partial R^{(m)}}{\partial \dot m} & \dfrac{\partial R^{(m)}}{\partial h} & \dfrac{\partial R^{(m)}}{\partial z} \\[4pt]
\dfrac{\partial R^{(p)}}{\partial p} & \dfrac{\partial R^{(p)}}{\partial \dot m} & \dfrac{\partial R^{(p)}}{\partial h} & \dfrac{\partial R^{(p)}}{\partial z} \\[4pt]
\dfrac{\partial R^{(h)}}{\partial p} & \dfrac{\partial R^{(h)}}{\partial \dot m} & \dfrac{\partial R^{(h)}}{\partial h} & \dfrac{\partial R^{(h)}}{\partial z} \\[4pt]
\dfrac{\partial R^{(z)}}{\partial p} & \dfrac{\partial R^{(z)}}{\partial \dot m} & \dfrac{\partial R^{(z)}}{\partial h} & \dfrac{\partial R^{(z)}}{\partial z}
\end{bmatrix}


$$

- 多数阻力件 $\partial\Delta p/\partial h\simeq 0$。
    
- 有功/换热件（压缩机、房间、换热器）在第三、四块会写入非零。
    

**参考压力**：每个连通分量固定 1 个 $p$（删变量或加强约束）避免奇异。  
**零流量光滑化**：  
$$  
\Delta p=K,\dot m\sqrt{\dot m^2+\varepsilon^2}\ \Rightarrow\ \frac{\partial\Delta p}{\partial \dot m}=K!\left(\sqrt{\dot m^2+\varepsilon^2}+\frac{\dot m^2}{\sqrt{\dot m^2+\varepsilon^2}}\right)!\ge K\varepsilon.  
$$

---

# 4) “设备 → 矩阵条目”一览

记号：

- 端口变量：`IM*_PRE/ENTHALPY/...`、`EX*_PRE/ENTHALPY/...`
    
- 边量：$\dot m$（对应 `EX*_FLOW` 或 `IM*_FLOW` 二择一）
    

## 4.1 管/弯管/变径（`RLS`、`CV`、`DN`、`PL`、`DENSITY`、`VISCOSITY`）

**残差**  
$$  
R^{(p)}=(A^T p)-\Delta p(\dot m;\rho,\mu,DN,PL),\quad  
\Delta p=K(\rho,\mu,DN,PL),\dot m\sqrt{\dot m^2+\varepsilon^2}  
$$

$$  
R^{(h)}=h^{ex}-h^{im}  
$$

**导数**

- $\partial R^{(p)}/\partial p$：在该边两端节点上写 $[-1,\ +1]$；
    
- $\partial R^{(p)}/\partial \dot m=-\partial\Delta p/\partial\dot m$（对角）；
    
- $\partial R^{(h)}/\partial h=[-1,\ +1]$（IM/EX）。
    

物性：`DENSITY`, `VISCOSITY` 通过 $\text{CoolProp}(p,h)$ 得；在一轮牛顿内缓存。

## 4.2 阀/旁通阀（`Opening`、`CV` 或 `R`）

**残差**  
$$  
R^{(p)}=(A^T p)-K(\text{CV},\theta),\dot m\sqrt{\dot m^2+\varepsilon^2},\qquad  
R^{(h)}=h^{ex}-h^{im}.  
$$

**导数**  
$$  
\frac{\partial R^{(p)}}{\partial \dot m}  
=-K!\left(\sqrt{\dot m^2+\varepsilon^2}+\frac{\dot m^2}{\sqrt{\dot m^2+\varepsilon^2}}\right),  
\quad  
\frac{\partial R^{(p)}}{\partial \theta}=-\frac{\partial K}{\partial \theta},\dot m\sqrt{\dot m^2+\varepsilon^2}.  
$$

## 4.3 毛细节流（`CV`、`DHIGH`、`MID_PRE` …）

**残差**  
$$  
R^{(p)}=(A^T p)-\Delta p(\dot m;\rho,\mu,\text{两相修正}),\qquad  
R^{(h)}=h^{ex}-h^{im}\quad(\text{等焓节流}).  
$$

**导数** 同阀门；能量对 $h$ 的导数同“管”。

## 4.4 泵（曲线法：`CURVE_A/B` 或 $H(\dot m)$）

**残差**  
$$  
R^{(p)}=(A^T p)+H(\dot m)=0  
$$  
（“加压”取正号）

若考虑温升：  
$$  
R^{(h)}=h^{ex}-h^{im}-\Delta h(\dot m)=0  
$$

**导数**  
$$  
\frac{\partial R^{(p)}}{\partial \dot m}=+H'(\dot m),\qquad  
\frac{\partial R^{(h)}}{\partial h}=[-1,+1].  
$$

**定压差/目标压差模式**（`Target_PRE/DPRE`）：  
$$  
R^{(p)}=(A^T p)-\mathrm{DPRE}=0.  
$$

## 4.5 螺杆压缩机（`ROTATE_SPEED`、`Opening`、`midK`、`OutPutPre`、`MuBiaoPre`、`POWER`…）

**残差（常用两条）**

1. 水力：  
    $$  
    R^{(p)}=(A^T p)+H(\dot m,n)=0  
    $$  
    或规定 $p^{ex}=\text{OutPutPre}$（边界式）。
    
2. 能量（等熵效率 $\eta_{is}$）：  
    $$  
    s^{im}=s(p^{im},h^{im}),\quad  
    h^{ex,s}=h!\left(p^{ex},s^{im}\right),\quad  
    R^{(h)}=h^{ex}-h^{im}-\frac{h^{ex,s}-h^{im}}{\eta_{is}}=0.  
    $$
    

**导数（要点）**

- $\partial R^{(p)}/\partial \dot m = +\partial H/\partial \dot m$；
    
- $\partial R^{(h)}/\partial h^{ex}=+1,\ \partial R^{(h)}/\partial h^{im}=-(1-1/\eta_{is})$；
    
- $\partial R^{(h)}/\partial p^{ex}$ 与 $\partial R^{(h)}/\partial p^{im}$ 通过物性链式法则（可用数值差分近似）。
    

## 4.6 房间/风机盘管（`InsideTemperature`、`FLOW_VOLUME`、`UA/负荷`）

**残差（后向欧拉）**  
$$  
C_a\frac{T^{k+1}-T^{k}}{\Delta t}  
-\dot m,c_p,(T_{im}-T^{k+1})

- Q_{load}(t)
    
- UA,(T_{out}-T^{k+1})=0.  
    $$
    

**导数（例）**  
$$  
\frac{\partial R}{\partial T^{k+1}}=\frac{C_a}{\Delta t}+\dot m c_p+UA,\quad  
\frac{\partial R}{\partial \dot m}=-c_p(T_{im}-T^{k+1}),  
$$  
以及经 $T(h,p)$ 的链导 $\partial R/\partial h^{im}$（简化可用常 $c_p$）。

## 4.7 贮液罐/容器（`BKT_LEVEL=L`、`BKT_H=h`、或 `BKT_TEMP`）

**残差（后向欧拉）**  
$$  
\begin{aligned}  
&\text{质量：}\quad \rho(L^{k+1},p),V(L^{k+1}) - \rho^{k}V^{k} - \Delta t\Big(\sum \dot m_{in}-\sum \dot m_{out}\Big)=0,\  \end{aligned}  
$$
$$\begin{aligned}  &\text{能量：}\quad \rho V h - (\rho V h)^{k} - \Delta t\Big(\sum \dot m,h_{in}-\sum \dot m,h_{out}-Q_{loss}\Big)=0.  
\end{aligned}  
$$

**导数要点**

- $\partial(\rho V)/\partial L$ 与 $\partial \rho/\partial p,\ \partial \rho/\partial h$（CoolProp 数值差分即可）。
    
- 对连到罐的边流量、端口焓都有偏导。
    

## 4.8 源头/边界（`OutPutPRE` / `Target_PRE` / 固定流量/焓）

- **固定节点压力**：$p-p_\star=0$（或直接消元该变量）。
    
- **固定边流量**：$\dot m-\dot m_\star=0$。
    
- **固定端口焓/温度**：$h^{im}-h_\star=0$。
    

> **每个连通分量必须至少一个压力参考，否则矩阵奇异。**

---

# 5) 组装流程（伪代码）

```cpp
// 1) 构图
build_incidence_matrix(A);           // Nn x Ne
choose_pressure_refs(per_component); // 每个连通分量固定一个 p

// 2) 物性缓存
for (each port) {
  rho = CoolProp_rho(p, h);
  mu  = CoolProp_mu(p, h);
  cache(port, rho, mu);
}

// 3) 逐设备写残差与雅可比
for (edge e : edges) {
  // 水力残差
  dpe      = p_out - p_in;
  dp_model = DeltaP(e, mdot[e], rho, mu, geom, opening, curve, eps);
  R_p[e]   = dpe - dp_model;

  // dR/dp: 两端节点
  J_p_p[ e, n_in ]  -= 1;
  J_p_p[ e, n_out ] += 1;

  // dR/dmdot:
  J_p_m[ e, e ] -= dDeltaP_dmdot(e, mdot[e], ...);

  // 能量残差
  if (is_passive(e)) {
    R_h[e] = h_ex[e] - h_im[e];
    J_h_h[e, idx(h_ex)] = +1;
    J_h_h[e, idx(h_im)] = -1;
  } else {
    // 压缩机/换热器/房间等
    write_energy_residual_and_jacobian(e, ...);
  }
}

// 4) 动态设备（罐/房间）
for (device d : storages) {
  write_mass_energy_BE(d, dt, J_blocks, R_blocks);
}

// 5) 节点连续性
R_m   = A * mdot - b;
J_m_m = A;

// 6) 线性求解（阻尼/线搜索）
solve_sparse(J, -R, dx);
x += dx;
```

---

# 6) 防奇异“硬规则”（务必落实）

1. **每个连通分量固定一个压力参考**（边界或罚项）。
    
2. **零流量光滑化 + 阀门最小开度**：  
    $$  
    \Delta p=K,\dot m\sqrt{\dot m^2+\varepsilon^2},\quad  
    \varepsilon \approx 10^{-4}\times \dot m_{\text{额定}},\quad \text{Opening}\ge 3%\text{–}10%.  
    $$
    
3. **并联极小微扰**：完全相同的并联在一支上乘 $1+\delta$（$\delta=10^{-3}$）。
    
4. **方程/未知配平**：统计  
    $$  
    N_{\text{unknown}} = N_n + N_e + 2N_e + N_z,  
    $$  
    方程数与之相等（含边界/参考约束）。
    
5. **初值**：给 $p,\dot m,h,z$ 合理初猜（蒸发/冷凝压、等焓节流、房间设温等），先固定物性做牛顿，再外层刷新物性 1–3 轮。
    
---
相关文档：
- [[水力求解器拓扑与矩阵体系——完整总结]]
- [[关于仿真平台的开发架构与对比]]
- [[矩阵变换类型及应用]]
- [[热工流体数值求解器开发常见难点与对策]]
- [[关于单个节点的水力耦合关系（三通管）]]
---
