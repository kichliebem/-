

## 1) 拓扑与变量顺序

三通（1 进 2 出）：
- 节点：上游 \(U\)、三通节点 \(J\)、下游 A、B。
- 边（支路）：
  - \(e_0: U $\to$ J\)
  - \(e_A: J $\to$ A\)
  - \(e_B: J $\to$ B\)

未知量按列顺序排：

$\boldsymbol{x} = [\,p_U,\ p_J,\ p_A,\ p_B\ \mid\ q_0,\ q_A,\ q_B\,]^T$


---

## 2) 关联矩阵 \(A\)（节点质量守恒）

约定：**该边在该节点“流出”记 +1，流入记 −1**。行=节点，列=边（\(e_0,e_A,e_B\)）：

$$
\begin{array}{c|rrr}
 & e_0 & e_A & e_B \\
\hline
U & +1 & 0 & 0 \\
J & -1 & +1 & +1 \\
A & 0 & -1 & 0 \\
B & 0 & 0 & -1 \\
\end{array}
$$

连续性残差：

$$
R^{(m)}(p,\dot m)=A\,\dot m - b = 0 \quad (\text{通常 } b=0)
$$

---

## 3) 压降方程（设备方程）与残差

每条边一条压降方程，写成 **节点压差 = 设备压降**：

$$
R^{(p)}(p,\dot m)=A^{T}p-\Delta p(\dot m)=0
$$

其中：

$$
A^{T}p =
\begin{bmatrix}
 p_U-p_J \\
 p_J-p_A \\
 p_J-p_B
\end{bmatrix},\quad
\Delta p(\dot m)=
\begin{bmatrix}
 \Delta p_0(q_0) \\
 \Delta p_A(q_A) \\
 \Delta p_B(q_B)
\end{bmatrix}.
$$

> 常用的光滑化压降模型（确保导数>0，避免奇异点）：
>
> $$
> \Delta p_e(q_e) = K_e\,q_e\,\sqrt{q_e^2+\varepsilon^2}\quad (e\in\{0,A,B\})
> $$
> $$
> \Rightarrow\ \frac{\partial \Delta p_e}{\partial q_e}
> = K_e\,\frac{2q_e^2+\varepsilon^2}{\sqrt{q_e^2+\varepsilon^2}}\ \stackrel{\text{记为}}{=}\ D_e\;>0
> $$

---

## 4) 牛顿步的水力雅可比（2×2 鞍点块）

把总残差写成：

$$
R(\boldsymbol{x}) =
\begin{bmatrix}
 R^{(m)} \\
 R^{(p)}
\end{bmatrix}
=
\begin{bmatrix}
 A\,\dot m - b \\
 A^{T}p - \Delta p(\dot m)
\end{bmatrix} = 0
$$

对 $([p\mid\dot m]$ 求导的雅可比：

$$
J =
\begin{bmatrix}
 \dfrac{\partial R^{(m)}}{\partial p} & \dfrac{\partial R^{(m)}}{\partial \dot m} \\
 \dfrac{\partial R^{(p)}}{\partial p} & \dfrac{\partial R^{(p)}}{\partial \dot m}
\end{bmatrix}
=
\begin{bmatrix}
 0 & A \\
 A^{T} & -D
\end{bmatrix},\qquad D=\operatorname{diag}(D_0,D_A,D_B)
$$

把它 **完全展开** 到上面给出的变量顺序 $\$([p_U,p_J,p_A,p_B\mid q_0,q_A,q_B]$$\)：

$$
\small
\left[
\begin{array}{cccc|ccc}
 0 & 0 & 0 & 0 & +1 & 0 & 0 \\
 0 & 0 & 0 & 0 & -1 & +1 & +1 \\
 0 & 0 & 0 & 0 & 0 & -1 & 0 \\
 0 & 0 & 0 & 0 & 0 & 0 & -1 \\\hline
 +1 & -1 & 0 & 0 & -D_0 & 0 & 0 \\
 0 & +1 & -1 & 0 & 0 & -D_A & 0 \\
 0 & +1 & 0 & -1 & 0 & 0 & -D_B
\end{array}
\right]
$$

对应的残差向量（便于测试装配是否正确）：

$$
\small
\begin{bmatrix}
 q_0 \\
 -q_0+q_A+q_B \\
 -q_A \\
 -q_B \\\hline
 p_U-p_J-\Delta p_0(q_0) \\
 p_J-p_A-\Delta p_A(q_A) \\
 p_J-p_B-\Delta p_B(q_B)
\end{bmatrix}
$$

---

## 5) 压力型舒尔补（自动“分配”是怎么出来的）

从上面的 2×2 鞍点系统消去 $\Delta\dot m$，得到仅关于压力的 SPD 方程：

$$
S\,\Delta p = -\big(R^{(m)} + A D^{-1} R^{(p)}\big),\qquad S = A D^{-1}A^{T}\;\;\text{(对称正定)}
$$

解出 $\Delta p$后回代：

$$
\Delta\dot m = D^{-1}\big(A^{T}\Delta p + R^{(p)}\big)
$$

> 物理含义：\(A\) 给出“**总量守恒**”，\(D^{-1}\) 代表各支路的“**导通程度（阻力斜率的倒数）**”。因此在同一压差下，**阻力小的支路分到的流量更大**，分配是数值解自动给出的。

---

## 6) 若三通存在**分流耦合**（更真实）

很多三通/三通阀的损失系数依赖分流比：

$$
 r_A=\frac{q_A}{q_0},\qquad r_B=\frac{q_B}{q_0}=1-r_A
$$

例如：

$$
\Delta p_A = K_A(r_A)\,q_A\,\sqrt{q_A^2+\varepsilon^2},\qquad
\Delta p_B = K_B(r_B)\,q_B\,\sqrt{q_B^2+\varepsilon^2}
$$

此时 \($D=\partial\Delta p/\partial\dot m$\) **不再对角**，会出现交叉项（仅示意）：

$$
\frac{\partial \Delta p_A}{\partial q_A}
= \underbrace{K_A'(r_A)\,\tfrac{\partial r_A}{\partial q_A}}_{\tfrac{K_A'(r_A)}{q_0}}\,q_A\sqrt{q_A^2+\varepsilon^2}
\;+
\;K_A\,\frac{2q_A^2+\varepsilon^2}{\sqrt{q_A^2+\varepsilon^2}}
$$

$$
\frac{\partial \Delta p_A}{\partial q_0}
= K_A'(r_A)\,\frac{\partial r_A}{\partial q_0}\,q_A\sqrt{q_A^2+\varepsilon^2}
= K_A'(r_A)\left(-\frac{q_A}{q_0^2}\right) q_A\sqrt{q_A^2+\varepsilon^2}
$$

把这些偏导装入 \(D\) 的相应位置即可，NR/舒尔补会给出更贴近真实的分配结果。

---

## 7) 小贴士（避免奇异/提高收敛）

- 零流量处用 \($\varepsilon$\) 光滑化；阀门设 $(\mathrm{Cv}_{\min})$（3–10%）。
- 每个连通分量固定一个参考压力（消元或罚项），避免零模。
- 并联完全对称时给参数加微小扰动（如 \(10^{-3}\)），避免非唯一。
- 用压力型舒尔补解 SPD 方程（Cholesky/PCG），稳且快；必要时加入阻尼牛顿/线搜索。
---
相关文档：
- [[水力求解器拓扑与矩阵体系——完整总结]]
- [[制冷回路拓补关联矩阵表示方法]]
- [[全局管网求解器方程与雅可比矩阵结构说明]]
- [[矩阵变换类型及应用]]
---




