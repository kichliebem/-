

## 一、系统目标

构建一个通用的水力求解框架，用以描述任意流体网络（管道、阀门、泵、储能设备等）。  
核心要求：

1. 支持设备级独立建模（设备自带方程与端口定义）；  
2. 系统级自动装配拓扑矩阵与雅可比矩阵；  
3. 同时支持稳态求解与动态仿真（DAE形式）；  
4. 能扩展至多物理场统一求解（热、储能、制冷系统等）。

---

## 二、设备、节点、端口与边的关系

| 概念 | 数学对象 | 求解器层意义 | 是否为未知量 |
|------|-----------|---------------|--------------|
| 节点 (Node) | 系统中具有压力（或水头）变量的点 | 表示一个设备的几何或逻辑位置 | 是 |
| 边 (Edge) | 连接两个节点的设备（管道、阀门、泵等） | 表示节点间的流量传递 | 是 |
| 端口 (Port) | 设备内部的流入/流出接口 | 定义设备的边界条件 | 否（辅助定义）|

当前系统中，“设备即节点”，每个设备含有若干端口。  
不同设备的端口通过“边”连接，形成网络。

---

## 三、四个节点、三条边的拓扑实例

示例系统：  
FixedHead → Valve → Pipe → Tank

节点编号：
1. fixed_head  
2. valve  
3. pipe  
4. tank

边编号：
1. e₁: fixed_head → valve  
2. e₂: valve → pipe  
3. e₃: pipe → tank

---

## 四、完整关联矩阵 (B_full)
关联矩阵的定义：

- 行代表节点（节点1到4），列代表边（e₁到e₃）。
- 矩阵元素 **aᵢⱼ** 表示节点 **i** 与边 **j** 的关系：
    - **aᵢⱼ = 1**：边 **j** 从节点 **i** 流出（节点是边的起点）。
    - **aᵢⱼ = -1**：边 **j** 流入节点 **i**（节点是边的终点）。
    - **aᵢⱼ = 0**：节点 **i** 与边 **j** 无关。

基于您的示例系统，关联矩阵如下：

| 节点 \ 边         | e₁ (1→2) | e₂ (2→3) | e₃ (3→4) |
| -------------- | -------- | -------- | -------- |
| 1 (fixed_head) | 1        | 0        | 0        |
| 2 (valve)      | -1       | 1        | 0        |
| 3 (pipe)       | 0        | -1       | 1        |
| 4 (tank)       | 0        | 0        | -1       |

**解释**：

- 边 e₁ 从节点1流出（值为1），流入节点2（值为-1）。
- 边 e₂ 从节点2流出（值为1），流入节点3（值为-1）。
- 边 e₃ 从节点3流出（值为1），流入节点4（值为-1）。

B 矩阵定义为：

$$
B_{ij} =
\begin{cases}
-1, & \text{边 } e_j \text{从节点 } i \text{流出}\\[4pt]
+1, & \text{边 } e_j \text{流入节点 } i\\[4pt]
0, & \text{节点 } i \text{与边 } e_j \text{无连接}
\end{cases}
$$

完整的 $B_{\text{full}}$（4×3）矩阵为：

$$
B_{\text{full}}=
\begin{bmatrix}
-1 &  0 &  0 \\[4pt]
+1 & -1 &  0 \\[4pt]
0  & +1 & -1 \\[4pt]
0  &  0 & +1
\end{bmatrix}
$$

解释：
- 每一列对应一条边；
- 每一行对应一个节点；
- 符号表示流向。

此矩阵完全表达了网络拓扑。

---

## 五、约化关联矩阵 (B_red)

在求解过程中，**固定水头节点（fixed_head）**与**水箱（tank）**的压力是边界条件，不参与方程求解。  
因此在装配系统方程时，只保留“内部节点”（valve、pipe）的连续性约束。

去掉边界节点行后：

$$
B_{\text{red}}=
\begin{bmatrix}
+1 & -1 & 0 \\[4pt]
0  & +1 & -1
\end{bmatrix}
$$

此矩阵对应两条连续性方程：
1. valve 节点：流入 e₁ − 流出 e₂ = 0  
2. pipe 节点：流入 e₂ − 流出 e₃ = 0  

这就是求解器中使用的 B 矩阵块。

---

## 六、物理意义与方程体系

网络方程分为两大类：

1. **节点连续性方程（质量守恒）**

   $$
   B_{\text{red}} \cdot q = 0
   $$

   其中 $q$ 为边流量向量。

2. **设备特性方程（能量守恒或压降关系）**

   $$
   f(P_i, P_j, q) = 0
   $$

   例如：

   - 管道：$P_i - P_j - K q|q| = 0$  
   - 阀门：$q - C_v α \sqrt{ΔP} = 0$  
   - 泵：$q - G(ΔP + H_p) = 0$

合并后，系统方程整体形式为：

$$
\begin{cases}
B_{\text{red}} q = 0 \\[4pt]
F(P, q) = 0
\end{cases}
$$

对应的雅可比矩阵：

$$
J =
\begin{bmatrix}
0 & B_{\text{red}} \\[4pt]
E & D
\end{bmatrix}
$$

其中：
- $B_{\text{red}}$：拓扑矩阵；
- $E$：设备方程对节点压力的偏导；
- $D$：设备方程对流量的偏导。

---

## 七、矩阵中符号与变量的区别

| 项目 | 含义 | 是否变化 | 示例 |
|------|------|----------|------|
| B矩阵元素 | 网络拓扑结构 | 固定 | +1 / −1 / 0 |
| q向量 | 每条边的流量 | 随迭代变化 | q₁, q₂, q₃ |
| P向量 | 各节点压力 | 随迭代变化 | P₁, P₂, P₃, P₄ |
| R_mass | 连续性残差 | 每次迭代计算 | Bq |

因此：
- B矩阵始终保持固定；
- 流量与压力随迭代变化；
- 方程残差由 Bq 和设备方程共同构成。

---

## 八、关于端口变量 (q_in, q_out)

在当前设计中：
- 不需要显式 q_in、q_out；
- 每条边的流量 $q_e$ 已唯一确定方向；
- 对应上游设备的“流出端口”和下游设备的“流入端口”共享同一个 $q_e$；
- 若流向反向，$q_e$ 取负值即可。

端口参数仅用于设备内部计算（如 `get_equations`），不进入系统方程。

---

## 九、容积类与源头类设备的特殊处理

1. **容积类设备（如水箱、房间）**

   - 稳态：视作已知水头的边界节点；
   - 动态：增加状态方程

     $$
     \frac{dP}{dt} = \frac{q_{in}-q_{out}}{V/C}
     $$

     由 DAE 求解器处理。

2. **源头类设备（固定水头或泵前水源）**

   - 边界条件：P 已知；
   - 在矩阵装配时，其对应行不参与求解；
   - 等价于常量约束方程 $H_i = H_{\mathrm{fixed}}$。

---

## 十、拓扑关系在矩阵中的显式表示

拓扑关系确实体现在矩阵中：
- B矩阵的稀疏结构（非零元素位置）直接映射网络结构；
- 每条非零元素的 +1/−1 表示方向；
- 设备连接模式可通过 B 的稀疏模式可视化（spy 图）直观显示。

---

## 十一、计算过程总结

1. 拓扑模块生成设备与节点对应关系，形成 B矩阵；
2. 求解器在每次迭代中使用当前 q、P 计算残差；
3. 设备方程贡献 E 和 D 块；
4. 节点连续性方程贡献 B 块；
5. 牛顿法迭代：

   $$
   J \Delta x = -R
   $$

6. 若引入容积类设备，则同时添加 $dP/dt$ 方程。

---

## 十二、结论

1. 设备抽象为节点，每个节点通过边（流量变量）相连；
2. B矩阵是系统拓扑的固定描述，元素为 +1/−1/0；
3. 流量向量 q、压力向量 P 是动态变量；
4. 系统方程由节点守恒和设备特性组成；
5. 源头和水箱为边界条件节点，不参与连续性方程；
6. 容积类设备通过动态方程引入时间维度；
7. 端口为内部模型结构，不进入系统矩阵；
8. 全局雅可比矩阵形式统一：

   $$
   J = \begin{bmatrix} 0 & B \\[4pt] E & D \end{bmatrix}
   $$

9. 真实系统（如 fixed_head → valve → pipe → tank）确实包含 4 个节点；
   - 完整 B 为 4×3；
   - 约化 B（去边界）为 2×3；
   - 这是求解器中打印矩阵行数少于节点数的原因。
---
相关文档：
- [[关于仿真平台的开发架构与对比]]
- [[关于单个节点的水力耦合关系（三通管）]]
- [[制冷回路拓补关联矩阵表示方法]]
- [[全局管网求解器方程与雅可比矩阵结构说明]]
- [[矩阵变换类型及应用]]
---

